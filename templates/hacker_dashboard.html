{% extends "base_new.html" %}

{% block title %}HACKER VIEW - NETWORK SNIFFER{% endblock %}

{% block extra_head %}
<style>
    /* Hacker Theme Overrides */
    body {
        background-color: #0a0a0a;
        color: #00ff41;
        font-family: 'Courier New', Courier, monospace;
    }

    .navbar {
        background-color: #001100 !important;
        border-bottom: 1px solid #00ff41;
    }

    .card {
        background-color: #000;
        border: 1px solid #00ff41;
        box-shadow: 0 0 10px rgba(0, 255, 65, 0.2);
    }

    .card-header {
        background-color: #001100;
        border-bottom: 1px solid #00ff41;
        color: #00ff41;
        font-weight: bold;
        text-transform: uppercase;
    }

    /* Terminal Styling */
    #terminal-window {
        height: 500px;
        overflow-y: auto;
        background-color: #000;
        padding: 10px;
        font-size: 0.9em;
    }

    .log-entry {
        margin-bottom: 5px;
        border-bottom: 1px dashed #333;
        padding-bottom: 2px;
        animation: fadeIn 0.3s ease-in;
    }

    .timestamp {
        color: #888;
        margin-right: 10px;
    }

    .ip {
        color: #00ccff;
    }

    .encrypted {
        color: #ff3333;
        word-break: break-all;
    }

    .meta {
        color: #ffff00;
    }

    /* Matrix Animation Background */
    #matrix-bg {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        opacity: 0.1;
        pointer-events: none;
    }

    /* Data Stream Animation */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }

        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .blinking-cursor::after {
        content: '_';
        animation: blink 1s step-end infinite;
    }

    @keyframes blink {
        50% {
            opacity: 0;
        }
    }

    .status-badge {
        background: #003300;
        border: 1px solid #00ff41;
        color: #00ff41;
        padding: 2px 8px;
        font-size: 0.8em;
        border-radius: 3px;
    }
</style>
{% endblock %}

{% block content %}
<canvas id="matrix-bg"></canvas>

<div class="row mb-4">
    <div class="col-12 text-center">
        <h1 class="display-4" style="text-shadow: 0 0 10px #00ff41;">
            <span class="blinking-cursor">NETWORK SNIFFER v2.0</span>
        </h1>
        <p class="lead">INTERCEPTING ENCRYPTED TRAFFIC...</p>
    </div>
</div>

<div class="row">
    <!-- Live Traffic Feed -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-terminal"></i> LIVE PACKET CAPTURE</span>
                <span class="status-badge">LISTENING</span>
            </div>
            <div class="card-body p-0">
                <div id="terminal-window">
                    <!-- Logs will be injected here -->
                    <div class="text-center text-muted mt-5">WAITING FOR NETWORK TRAFFIC...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats & Info -->
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header">Target System Status</div>
            <div class="card-body">
                <p><strong>ENCRYPTION:</strong> <span class="text-danger">AES-256-CBC (STRONG)</span></p>
                <p><strong>INTEGRITY:</strong> <span class="text-danger">HMAC-SHA256 (ACTIVE)</span></p>
                <p><strong>KEY EXCHANGE:</strong> <span class="text-danger">ECDH (SECURE)</span></p>
                <hr style="border-color: #00ff41;">
                <p class="small text-muted">Analyzing handshake protocols...</p>
                <div class="progress" style="height: 5px; background-color: #003300;">
                    <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" style="width: 100%">
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Decryption Attempt</div>
            <div class="card-body text-center">
                <h1 class="display-1">üîí</h1>
                <h5 class="card-title text-danger">ACCESS DENIED</h5>
                <p class="card-text small">Unable to decrypt payload without private keys.</p>
                <button class="btn btn-outline-danger w-100 disabled">BRUTE FORCE (EST. 10^50 YEARS)</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    // Matrix Rain Effect
    const canvas = document.getElementById('matrix-bg');
    const ctx = canvas.getContext('2d');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const katakana = '„Ç¢„Ç°„Ç´„Çµ„Çø„Éä„Éè„Éû„É§„É£„É©„ÉØ„Ç¨„Ç∂„ÉÄ„Éê„Éë„Ç§„Ç£„Ç≠„Ç∑„ÉÅ„Éã„Éí„Éü„É™„É∞„ÇÆ„Ç∏„ÉÇ„Éì„Éî„Ç¶„Ç•„ÇØ„Çπ„ÉÑ„Éå„Éï„É†„É¶„É•„É´„Ç∞„Ç∫„Éñ„ÉÖ„Éó„Ç®„Çß„Ç±„Çª„ÉÜ„Éç„Éò„É°„É¨„É±„Ç≤„Çº„Éá„Éô„Éö„Ç™„Ç©„Ç≥„ÇΩ„Éà„Éé„Éõ„É¢„É®„Éß„É≠„É≤„Ç¥„Çæ„Éâ„Éú„Éùvu0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    const characters = katakana.split('');

    const fontSize = 16;
    const columns = canvas.width / fontSize;

    const drops = [];
    for (let x = 0; x < columns; x++) {
        drops[x] = 1;
    }

    function draw() {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = '#0F0';
        ctx.font = fontSize + 'px arial';

        for (let i = 0; i < drops.length; i++) {
            const text = characters[Math.floor(Math.random() * characters.length)];
            ctx.fillText(text, i * fontSize, drops[i] * fontSize);

            if (drops[i] * fontSize > canvas.height && Math.random() > 0.975)
                drops[i] = 0;

            drops[i]++;
        }
    }
    setInterval(draw, 33);

    // Traffic Sniffer Logic
    let lastId = 0;
    const terminal = document.getElementById('terminal-window');

    function fetchTraffic() {
        fetch("{{ url_for('api_sniffer') }}")
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    // Filter for new packets
                    const newPackets = data.filter(p => p.id > lastId);

                    if (newPackets.length > 0) {
                        // If it's the first load, just set the lastId
                        if (lastId === 0) {
                            terminal.innerHTML = ''; // Clear "Waiting..." message
                        }

                        // Process new packets (reverse to show oldest first if multiple come in)
                        newPackets.reverse().forEach(packet => {
                            lastId = Math.max(lastId, packet.id);

                            const entry = document.createElement('div');
                            entry.className = 'log-entry';
                            entry.innerHTML = `
                                <span class="timestamp">[${packet.timestamp}]</span>
                                <span class="ip">${packet.source_ip}</span> <span class="text-muted">-></span> <span class="ip">${packet.dest_ip}</span>
                                <span class="meta">[${packet.protocol}]</span>
                                <div>Payload: <span class="encrypted">${packet.encrypted_payload}</span></div>
                                <div class="small text-muted">IV: ${packet.iv.substring(0, 20)}... | HMAC: ${packet.hmac.substring(0, 20)}...</div>
                            `;

                            terminal.appendChild(entry);

                            // Auto-scroll to bottom
                            terminal.scrollTop = terminal.scrollHeight;
                        });
                    }
                }
            });
    }

    // Poll every 1.5 seconds
    setInterval(fetchTraffic, 1500);
</script>
{% endblock %}